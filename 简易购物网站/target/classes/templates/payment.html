<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>支付页</title>
  <th:block th:replace="fragments/layout :: headlinks"></th:block>
</head>
<body>
  <th:block th:replace="fragments/layout :: header"></th:block>
  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">订单详情</div>
          <div class="card-body">
            <div class="mb-3">
              <span class="me-3">订单ID：<strong id="orderId" th:text="${order.id}"></strong></span>
              <span class="me-3">状态：<strong id="orderStatus" th:text="${order.status}"></strong></span>
              <span>总价：<strong class="price" th:text="${order.total}"></strong></span>
            </div>
            <table class="table table-striped">
              <thead><tr><th>名称</th><th>单价</th><th>数量</th></tr></thead>
              <tbody>
              <tr th:each="item : ${order.items}">
                <td th:text="${item.product.name}"></td>
                <td th:text="${item.unitPrice}"></td>
                <td th:text="${item.quantity}"></td>
              </tr>
              </tbody>
            </table>
            <form th:action="@{'/order/' + ${order.id} + '/pay'}" method="post" class="mt-3">
              <button id="payBtn" class="btn btn-success" type="submit">支付</button>
              <a class="btn btn-outline-secondary ms-2" href="/shop">返回购物</a>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  <th:block th:replace="fragments/layout :: footer"></th:block>
  <script th:inline="javascript">
    const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(wsProto + '://' + location.host + '/ws/orders');
    ws.onmessage = (e) => {
      const msg = String(e.data || '');
      if (msg.startsWith('ORDER_PAID:')) {
        const oid = Number(msg.split(':')[1]);
        const currentId = Number(document.getElementById('orderId').textContent);
        if (oid === currentId) {
          const statusEl = document.getElementById('orderStatus');
          if (statusEl) statusEl.textContent = 'PAID';
          const btn = document.getElementById('payBtn');
          if (btn) { btn.disabled = true; btn.textContent = '已支付'; }
        }
      }
    };
  </script>
</body>
</html>
