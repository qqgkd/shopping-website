<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>实时销售监控</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/app.css" rel="stylesheet">
  <style>
    .monitor-feed { max-height: 80vh; overflow-y: auto; }
    .sale-item { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">简易商城 - 实时销售监控</span>
    </div>
  </nav>
  <main class="container py-4">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>实时交易流水</span>
            <span id="status" class="badge bg-secondary">连接中...</span>
          </div>
          <div class="card-body monitor-feed">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>时间</th>
                  <th>用户</th>
                  <th>商品详情</th>
                  <th>总金额</th>
                </tr>
              </thead>
              <tbody id="salesList">
              </tbody>
            </table>
            <div id="emptyTip" class="text-center text-muted py-5">暂无新交易</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(wsProto + '://' + location.host + '/ws/orders');
    const list = document.getElementById('salesList');
    const emptyTip = document.getElementById('emptyTip');
    const status = document.getElementById('status');

    ws.onopen = () => {
      status.textContent = '已连接';
      status.className = 'badge bg-success';
    };
    ws.onclose = () => {
      status.textContent = '断开';
      status.className = 'badge bg-danger';
    };

    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'SALE') {
          emptyTip.classList.add('d-none');
          const tr = document.createElement('tr');
          tr.className = 'sale-item';
          
          // Format items
          const itemsHtml = msg.items.map(i => 
            `<span class="badge bg-info text-dark me-1">${i.product} x${i.quantity}</span>`
          ).join('');

          tr.innerHTML = `
            <td>${new Date().toLocaleTimeString()}</td>
            <td><strong>${msg.user}</strong></td>
            <td>${itemsHtml}</td>
            <td class="text-success fw-bold">¥${msg.total}</td>
          `;
          
          list.insertBefore(tr, list.firstChild);
          
          // Keep list size manageable
          if (list.children.length > 50) list.lastChild.remove();
        }
      } catch (err) {
        console.error('Parse error', err);
      }
    };
  </script>
</body>
</html>
